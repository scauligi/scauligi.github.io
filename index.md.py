#!/usr/bin/env python3

from ruamel.yaml import YAML

MD = """<!-- generated by index.md.py -->

## [Research and Publications](reviews.html){:.title-image}

"""

yaml = YAML()

def main():
    with open("_data/papers.yaml") as fp:
        data = yaml.load(fp)

    with open("index.md", "w") as fp:
        print(MD, file=fp)
        for paper in data["papers"]:
            if subtitle := paper.get("subtitle", ""):
                subsub = None
                if ' :: ' in subtitle:
                    subtitle, subsub = subtitle.split(' :: ', 1)
                subtitle = f'<span class="subtitle">{subtitle}</span>'
                if subsub:
                    subtitle += f''' <span style="vertical-align: text-top;">&middot;</span>
                                     <span class="subsubtitle">{subsub}</span>'''
                subtitle += "\\\n"
            title = f'**{paper["title"]}**'
            if "title_image" in paper:
                title = f'[{title}]({paper["title_image"]}){{:.title-image}}'
            fp.write(subtitle + title)
            if paper.get("links"):
                links = ""
                for link in paper["links"]:
                    (key, val) ,= link.items()
                    key = key.replace("_newtab", "")
                    if key.startswith("("):
                        links += " &middot; "
                    else:
                        links += " \\| "
                    links += f'[{key}]({val}){{:target="blank"}}'
                links = links[4:]
                fp.write(f' &nbsp; [ {links} ]')
            fp.write("\\\n")
            fp.write(", ".join(paper.get("authors", [])))
            fp.write("\\\n")
            venue = paper.get("venue", "")
            venue = venue.replace("'", "\\'")
            longvenue = paper.get("longvenue", "")
            venuelink = paper.get("venue_link", "#")
            if not longvenue:
                venue = f'<span class="no-fullvenue">{venue}</span>'
            else:
                venue = f'[{venue}]({venuelink}){{:.hover-over title="{longvenue}"}}'
            if venuetag := paper.get("venue_tag"):
                venue += f' <span class="no-fullvenue">({venuetag})</span>'
            fp.write(venue)
            fp.write("\n\n")

if __name__ == "__main__":
    main()
